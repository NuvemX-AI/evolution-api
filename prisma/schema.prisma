// -------------------------------------------------------------
//  PRISMA CONFIG
// -------------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // ou seu provider
  url      = env("DATABASE_URL")
}

// -------------------------------------------------------------
//  ENUMS
// -------------------------------------------------------------
// NOTE: Se usar string literals no código ('all', 'keyword'), defina como string no schema.
// Se usar Enum no código ($Enums.TriggerType.keyword), mantenha o Enum aqui.
enum TriggerType {
  keyword
  schedule
  webhook
  always
  advanced
  all
}

enum TriggerOperator {
  equals
  contains
  startsWith
  endsWith
}

enum DifyBotType {
  chat
  agent
  workflow
}

enum OpenaiBotType {
  completion
  assistant
}

// -------------------------------------------------------------
//  MODELS
// -------------------------------------------------------------
model Instance {
  id                      String    @id @default(uuid())
  name                    String    @unique
  number                  String?
  token                   String?
  clientName              String?
  connectionStatus        String?
  profileName             String?
  profilePicUrl           String?
  integration             String?
  ownerJid                String?
  businessId              String?
  disconnectionAt         DateTime?
  disconnectionReasonCode Int?
  disconnectionObject     String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // --- Relações ---
  // Configurações (1-1)
  webhook             Webhook?
  proxy               Proxy?
  rabbitmq            Rabbitmq?
  sqs                 Sqs?
  websocket           Websocket?
  setting             Setting?
  pusher              Pusher?
  chatwoot            Chatwoot? // Relação 1-1 inversa
  difySetting         DifySetting? // Relação 1-1 inversa
  evolutionBotSetting EvolutionBotSetting? // Relação 1-1 inversa
  flowiseSetting      FlowiseSetting? // Relação 1-1 inversa
  openaiSetting       OpenaiSetting? // Relação 1-1 inversa
  typebotSetting      TypebotSetting? // Relação 1-1 inversa

  // Dados WA (1-N)
  sessions            Session[]
  chats               Chat[]
  contacts            Contact[]
  messages            Message[]
  messageUpdates      MessageUpdate[]
  labels              Label[]
  isOnWhatsappChecks  IsOnWhatsapp[] // Relação 1-N inversa

  // Bots (1-N)
  difyBots            Dify[]
  evolutionBots       EvolutionBot[]
  flowiseBots         Flowise[]
  openaiBots          OpenaiBot[]
  typebots            Typebot[]
  integrationSessions IntegrationSession[] // Relação 1-N inversa

  // Outras Relações (1-N)
  whatsappIntegrations WhatsappIntegration[]
  media               Media[]
  templates           Template[]

  @@index([ownerJid])
}

// ----------------------------------------------------------------
model Session {
  id         String   @id @default(uuid())
  sessionId  String   @unique
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  creds      Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([instanceId])
}

// ----------------------------------------------------------------
model Chat {
  id             String   @id @default(uuid())
  instanceId     String
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  remoteJid      String
  name           String?
  labels         Json?
  unreadMessages Int?     @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([instanceId, remoteJid])
  @@index([instanceId])
  @@index([remoteJid])
}

// ----------------------------------------------------------------
model Contact {
  id            String   @id @default(uuid())
  instanceId    String
  instance      Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  remoteJid     String
  pushName      String?
  profilePicUrl String?
  identifier    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([instanceId, remoteJid])
  @@index([instanceId])
  @@index([remoteJid])
}

// ----------------------------------------------------------------
model Message {
  id                       String    @id @default(uuid())
  instanceId               String
  instance                 Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  keyId                    String?   @unique
  key                      Json?
  message                  Json?
  messageTimestamp         BigInt?   @db.BigInt
  messageType              String?
  status                   String?
  participant              String?
  webhookUrl               String?
  source                   String?
  contextInfo              Json?
  integrationSessionId     String? // Chave estrangeira para IntegrationSession
  integrationSession       IntegrationSession? @relation(fields: [integrationSessionId], references: [id], onDelete: SetNull) // Relação corrigida

  chatwootIsRead           Boolean?
  chatwootMessageId        String?
  chatwootConversationId   String?
  chatwootInboxId          String?
  chatwootContactInboxSourceId String?

  updates                  MessageUpdate[]
  mediaId                  String?   @unique // Chave estrangeira para Media (1-1)
  media                    Media?    @relation(fields: [mediaId], references: [id], onDelete: SetNull) // Relação corrigida

  @@index([instanceId])
  @@index([integrationSessionId])
  @@index([keyId])
  @@index([messageTimestamp])
}

// ----------------------------------------------------------------
model MessageUpdate {
  id             String   @id @default(uuid())
  instanceId     String
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  messageId      String   // ID da nossa Message
  message        Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  keyId          String?  // ID da Baileys Message Key
  remoteJid      String?
  participant    String?
  status         String?
  timestamp      BigInt?  @db.BigInt
  createdAt      DateTime @default(now())

  @@index([instanceId])
  @@index([messageId])
  @@index([keyId])
}

// --- Modelos de Configuração da Instância ---

model Webhook {
  id             String   @id @default(uuid())
  instanceId     String   @unique
  instance       Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  enabled        Boolean? @default(false)
  url            String?
  webhookBase64  Boolean? @default(false)
  headers        Json?
  events         String[] @default([])

  @@index([instanceId])
}

model Chatwoot {
  id                      String   @id @default(uuid())
  instanceId              String   @unique
  instance                Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  enabled                 Boolean? @default(false)
  accountId               String?
  token                   String?
  url                     String?
  nameInbox               String?
  signMsg                 Boolean? @default(false)
  signDelimiter           String?  @default("\\n")
  number                  String?
  reopenConversation      Boolean? @default(false)
  conversationPending     Boolean? @default(false)
  mergeBrazilContacts     Boolean? @default(false)
  importContacts          Boolean? @default(false)
  importMessages          Boolean? @default(false)
  daysLimitImportMessages Int?     @default(90)
  organization            String?
  logo                    String?
  ignoreJids              String[] @default([])

  @@index([instanceId])
}

model Proxy {
  id         String   @id @default(uuid())
  instanceId String   @unique
  instance   Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  enabled    Boolean? @default(false)
  host       String?
  port       Int?
  protocol   String?
  username   String?
  password   String?

  @@index([instanceId])
}

model Rabbitmq {
  id          String   @id @default(uuid())
  instanceId  String   @unique
  instance    Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  url         String?
  exchange    String?
  enabled     Boolean? @default(false)
  events      String[] @default([])

  @@index([instanceId])
}

model Sqs {
  id              String   @id @default(uuid())
  instanceId      String   @unique
  instance        Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  region          String?
  queueUrl        String?
  accessKeyId     String?
  secretAccessKey String?
  enabled         Boolean? @default(false)
  events          String[] @default([])

  @@index([instanceId])
}

model Websocket {
  id         String   @id @default(uuid())
  instanceId String   @unique
  instance   Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  enabled    Boolean? @default(false)
  events     String[] @default([])

  @@index([instanceId])
}

model Setting {
  id               String   @id @default(uuid())
  instanceId       String   @unique
  instance         Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  rejectCall       Boolean? @default(false)
  msgCall          String?
  groupsIgnore     Boolean? @default(false)
  ignoredGroupJids String[] @default([])
  alwaysOnline     Boolean? @default(false)
  readMessages     Boolean? @default(false)
  readStatus       Boolean? @default(false)
  syncFullHistory  Boolean? @default(false)
  wavoipToken      String?

  @@index([instanceId])
}

model Pusher {
  id         String   @id @default(uuid())
  instanceId String   @unique
  instance   Instance @relation(fields: [instanceId], references: [id]) // Relação inversa adicionada
  enabled    Boolean? @default(false)
  appId      String?
  key        String?
  secret     String?
  cluster    String?
  useTLS     Boolean? @default(true)
  events     String[] @default([])

  @@index([instanceId])
}

// --- Modelos de Integração (Bots) ---

model IntegrationSession {
  id                        String    @id @default(uuid())
  instanceId                String
  instance                  Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  botId                     String?   // ID do bot associado
  remoteJid                 String
  integrationSpecificSessionId String?   // ID da sessão específica da integração (ex: conversation_id Dify) - Renomeado de sessionId
  pushName                  String?   // Adicionado
  status                    String?
  awaitUser                 Boolean?  @default(false)
  type                      String?   // 'dify', 'evolution', 'openai', 'typebot', 'flowise'
  context                   Json?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  // Relações inversas explícitas (opcional)
  difyBot                   Dify?      @relation(fields: [botId], references: [id]) // Precisa de nome diferente se botId for usado por múltiplos tipos
  evolutionBot              EvolutionBot? @relation(fields: [botId], references: [id])
  flowiseBot                Flowise?   @relation(fields: [botId], references: [id])
  openaiBot                 OpenaiBot? @relation(fields: [botId], references: [id])
  typebot                   Typebot?   @relation(fields: [botId], references: [id])

  // Relação inversa para Message (1-N)
  messages                  Message[]

  @@index([instanceId, remoteJid, type])
  @@index([instanceId])
  @@index([botId])
  @@index([remoteJid])
}

// Modelo Dify
model Dify {
  id            String   @id @default(uuid())
  instanceId    String
  instance      Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  description   String?
  apiKey        String?
  apiUrl        String?
  botType       DifyBotType?
  enabled       Boolean? @default(true)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?

  // Relação com Fallback
  fallbackSetting DifySetting[] @relation("DifyFallback")

  // Relação inversa com Sessões
  sessions        IntegrationSession[] // Removida a definição explícita com fields/references

  @@index([instanceId])
  @@index([enabled])
}

// Configurações Globais/Fallback Dify por Instância
model DifySetting {
  id             String   @id @default(uuid())
  instanceId     String   @unique
  instance       Instance @relation(fields: [instanceId], references: [id]) // Relação inversa
  difyIdFallback String?  @unique
  Fallback       Dify?    @relation("DifyFallback", fields: [difyIdFallback], references: [id], onDelete: SetNull)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  @@index([instanceId])
}

// Modelo EvolutionBot
model EvolutionBot {
  id             String   @id @default(uuid())
  instanceId     String
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  description    String?
  apiKey         String?
  apiUrl         String?
  model          String?
  enabled        Boolean? @default(true)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?

  fallbackSetting EvolutionBotSetting[] @relation("EvolutionBotFallback")
  sessions        IntegrationSession[] // Relação inversa implícita

  @@index([instanceId])
  @@index([enabled])
}

// Configurações Globais/Fallback EvolutionBot por Instância
model EvolutionBotSetting {
  id              String      @id @default(uuid())
  instanceId      String      @unique
  instance        Instance    @relation(fields: [instanceId], references: [id]) // Relação inversa
  botIdFallback   String?     @unique
  Fallback        EvolutionBot? @relation("EvolutionBotFallback", fields: [botIdFallback], references: [id], onDelete: SetNull)

  expire          Int?        @default(0)
  keywordFinish   String?
  delayMessage    Int?        @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean?    @default(false)
  stopBotFromMe   Boolean?    @default(false)
  keepOpen        Boolean?    @default(false)
  debounceTime    Int?        @default(0)
  ignoreJids      String[]    @default([])
  splitMessages   Boolean?    @default(false)
  timePerChar     Int?        @default(0)

  @@index([instanceId])
}

// Modelo Flowise
model Flowise {
  id             String   @id @default(uuid())
  instanceId     String
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  description    String?
  url            String
  apiKey         String?
  enabled        Boolean? @default(true)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?

  fallbackSetting FlowiseSetting[] @relation("FlowiseFallback")
  sessions        IntegrationSession[] // Relação inversa implícita

  @@index([instanceId])
  @@index([enabled])
}

// Configurações Globais/Fallback Flowise por Instância
model FlowiseSetting {
  id             String   @id @default(uuid())
  instanceId     String   @unique
  instance       Instance @relation(fields: [instanceId], references: [id]) // Relação inversa
  botIdFallback  String?  @unique
  Fallback       Flowise? @relation("FlowiseFallback", fields: [botIdFallback], references: [id], onDelete: SetNull)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  @@index([instanceId])
}

// Modelo OpenaiBot
model OpenaiBot {
  id              String   @id @default(uuid())
  instanceId      String
  instance        Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  enabled         Boolean? @default(true)

  botType         OpenaiBotType?
  model           String?
  assistantId     String?
  maxTokens       Int?
  temperature     Float?
  prompt          String?
  functionUrl     String?
  speechToText    Boolean? @default(false)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?

  credsId         String?  // FK para OpenaiCreds
  creds           OpenaiCreds? @relation(fields: [credsId], references: [id])

  fallbackSetting OpenaiSetting[] @relation("OpenaiBotFallback")
  sessions        IntegrationSession[] // Relação inversa implícita

  @@index([instanceId])
  @@index([enabled])
  @@index([credsId])
}

// Credenciais OpenAI
model OpenaiCreds {
  id         String      @id @default(uuid())
  name       String?
  apiKey     String      @unique // API Key deve ser única? Ou permitir a mesma chave em vários registros? Removido unique por precaução.
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  openaiBots OpenaiBot[] // Relação inversa
}

// Configurações Globais/Fallback OpenAI por Instância
model OpenaiSetting {
   id             String     @id @default(uuid())
   instanceId     String     @unique
   instance       Instance   @relation(fields: [instanceId], references: [id]) // Relação inversa
   botIdFallback  String?    @unique
   Fallback       OpenaiBot? @relation("OpenaiBotFallback", fields: [botIdFallback], references: [id], onDelete: SetNull)

   expire          Int?     @default(0)
   keywordFinish   String?
   delayMessage    Int?     @default(1000)
   unknownMessage  String?
   listeningFromMe Boolean? @default(false)
   stopBotFromMe   Boolean? @default(false)
   keepOpen        Boolean? @default(false)
   debounceTime    Int?     @default(0)
   ignoreJids      String[] @default([])
   splitMessages   Boolean? @default(false)
   timePerChar     Int?     @default(0)
   speechToText    Boolean? @default(false)
   model           String?
   maxTokens       Int?
   temperature     Float?
   prompt          String?

   @@index([instanceId])
}

// Modelo Typebot
model Typebot {
  id             String   @id @default(uuid())
  instanceId     String
  instance       Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  description    String?
  url            String
  typebot        String? // Nome/ID do fluxo
  enabled        Boolean? @default(true)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  triggerType     TriggerType?
  triggerOperator TriggerOperator?
  triggerValue    String?

  fallbackSetting TypebotSetting[] @relation("TypebotFallback")
  sessions        IntegrationSession[] // Relação inversa implícita

  @@index([instanceId])
  @@index([enabled])
}

// Configurações Globais/Fallback Typebot por Instância
model TypebotSetting {
  id             String   @id @default(uuid())
  instanceId     String   @unique
  instance       Instance @relation(fields: [instanceId], references: [id]) // Relação inversa
  botIdFallback  String?  @unique
  Fallback       Typebot? @relation("TypebotFallback", fields: [botIdFallback], references: [id], onDelete: SetNull)

  expire          Int?     @default(0)
  keywordFinish   String?
  delayMessage    Int?     @default(1000)
  unknownMessage  String?
  listeningFromMe Boolean? @default(false)
  stopBotFromMe   Boolean? @default(false)
  keepOpen        Boolean? @default(false)
  debounceTime    Int?     @default(0)
  ignoreJids      String[] @default([])
  splitMessages   Boolean? @default(false)
  timePerChar     Int?     @default(0)

  @@index([instanceId])
}

// --- Outros Modelos ---

model Label {
  id            String   @id @default(uuid())
  instanceId    String
  instance      Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  labelId       String   // ID da label no WhatsApp
  name          String
  color         String?
  predefinedId  String?

  @@unique([instanceId, labelId])
  @@index([instanceId])
}

model WhatsappIntegration {
  id          String   @id @default(uuid())
  instanceId  String
  instance    Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  phoneNumber String?
  apiToken    String?
  status      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([instanceId])
}

model Media {
  id            String   @id @default(uuid())
  instanceId    String
  instance      Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  // Relação com Message movida para Message
  // messageId     String?
  // message       Message? ...
  keyId         String?  // ID da chave Baileys da mensagem original
  remoteJid     String?
  mediaKey      String?
  url           String?
  directPath    String?
  mimetype      String
  fileEncSha256 String?
  fileSha256    String?
  fileLength    BigInt?  @db.BigInt
  fileName      String?
  createdAt     DateTime @default(now())

  @@index([instanceId])
  @@index([keyId])
  // @@index([messageId]) // Remover se messageId for removido
}

model Template {
  id         String   @id @default(uuid())
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  name       String
  templateId String?  @unique
  language   String
  category   String?
  components Json?
  status     String?
  webhookUrl String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([instanceId, name, language])
  @@index([instanceId])
}

model IsOnWhatsapp {
  id         String   @id @default(uuid())
  remoteJid  String   @unique
  isOnWa     Boolean
  checkedAt  DateTime @default(now())
  instanceId String? // A qual instância pertence esta verificação? (Opcional)
  instance   Instance? @relation(fields: [instanceId], references: [id], onDelete: SetNull) // Relação inversa adicionada

  @@index([remoteJid])
  @@index([checkedAt])
  @@index([instanceId]) // Adicionado índice
}
